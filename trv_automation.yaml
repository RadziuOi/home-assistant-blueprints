blueprint:
  name: Sterowanie ogrzewaniem (Smart Heating - Climate/TRV - Lokalizacja Osób)
  description: |
    Automatyczne sterowanie Termostatycznym Zaworem Grzejnikowym (TRV) / Climate na podstawie:
      • Temperatury wewnętrznej (z histerezą),
      • Harmonogramu czasowego (docelowa temperatura),
      • Obecności wielu osób w domu (sprawdzane na podstawie lokalizacji).
    
    Jeśli ktokolwiek (Tracker) jest w stanie 'home', używany jest Harmonogram.
    Jeśli wszystkie osoby są 'not_home', używana jest Temperatura Nieobecności.
  domain: automation
  input:
    # Czujnik temperatury zewnętrznej
    external_temp_sensor:
      name: Temperatura zewnętrzna
      description: Sensor typu temperature
      selector:
        entity:
          domain: sensor
    
    # Czujnik temperatury wewnętrznej
    internal_temp_sensor:
      name: Temperatura wewnętrzna
      description: Sensor temperatury pomieszczenia, który ma być kontrolowany
      selector:
        entity:
          domain: sensor

    # TRV / Termostat do sterowania
    heating_entity:
      name: TRV / Termostat (Encja Climate)
      description: Encja Climate, której tryb HVAC zostanie ustawiony (np. climate.trv_salon)
      selector:
        entity:
          domain: climate 

    # Lista trackerów lokalizacji
    presence_entities:
      name: Sensory/Trackery Lokalizacji Osób
      description: Lista encji, które zwracają 'home' lub 'not_home' (np. person.janek, device_tracker.iphone_oli).
      selector:
        entity:
          domain: [person, device_tracker] # Zmieniono na domeny lokalizacyjne
          multiple: true 

    # Temperatura docelowa dla nieobecności
    away_temp:
      name: Temperatura Nieobecności (Away Temp)
      description: Docelowa temperatura, gdy WSZYSTKIE wybrane osoby są nieobecne (oszczędność).
      default: 18.0
      selector:
        number:
          min: 10.0
          max: 25.0
          step: 0.5
          unit_of_measurement: °C
          
    # Częstotliwość sprawdzania (sekundy)
    check_interval:
      name: Interwał sprawdzania (s)
      default: 60
      selector:
        number:
          min: 10
          max: 3600
          unit_of_measurement: s

    # Temperatura docelowa w zależności od czasu (Tryb Dzień)
    temp_schedule:
      name: Harmonogram temperatury (Tryb Dzień)
      description: |
        Lista wpisów z czasem, dniami oraz temperaturą dla trybu obecności.
        Wartości z "temp" będą służyły jako docelowe dla histerezy.
      selector:
        object:

    # Temperatura maksymalna zewnętrzna, po której grzanie wyłączone
    max_external_temp:
      name: Maksymalna temperatura zewnętrzna (Bezpiecznik)
      default: 25
      selector:
        number:
          unit_of_measurement: °C
    
    # Histereza temperatury (krok)
    temperature_hysteresis:
      name: Histereza temperatury (krok)
      description: Margines (np. 0.5 °C) zapobiegający częstemu przełączaniu trybu HVAC.
      default: 0.0
      selector:
        number:
          min: 0.0
          max: 5.0
          step: 0.1
          unit_of_measurement: °C

mode: restart

trigger:
  - platform: time_pattern
    minutes: "/{{ trigger.input.check_interval }}"
  
action:
  - alias: "Pobierz aktualne wartości"
    variables:
      now_time: "{{ now().time() }}"
      weekday: "{{ now().strftime('%a').lower() }}"
      ext_temp: "{{ states(trigger.input.external_temp_sensor) | float(0) }}"
      int_temp: "{{ states(trigger.input.internal_temp_sensor) | float(0) }}"
      hysteresis: "{{ trigger.input.temperature_hysteresis | float(0) }}"
      
      # ZOPTYMALIZOWANA LOGIKA: Sprawdzenie, czy przynajmniej JEDNA osoba jest w domu ('home')
      is_anyone_home: >-
        {% set presence_list = expand(trigger.input.presence_entities) | map(attribute='state') | list %}
        {{ 'home' in presence_list }} # Wystarczy, że którykolwiek tracker ma stan 'home'
      
      # Ustalenie docelowej temperatury: Harmonogram LUB Temperatura Nieobecności
      target_temp: >-
        {% if is_anyone_home %}
          {% set entries = trigger.input.temp_schedule %}
          {% set matched_entry = entries | selectattr('days', 'contains', weekday) 
                                       | select('is_defined')
                                       | selectattr('start', 'lt', now_time.strftime('%H:%M'))
                                       | selectattr('end', 'gt', now_time.strftime('%H:%M'))
                                       | list %}
          {% set temp = (matched_entry | first).temp | default(null) %}
          {{ temp | default(null) }}
        {% else %}
          {{ trigger.input.away_temp | float(0) }}
        {% endif %}

  - alias: "Decyzja o włączeniu/wyłączeniu grzania (TRV/Climate)"
    choose:
      # 1. Brak ustalonej temperatury w harmonogramie (gdy jest luka)
      - conditions:
          - condition: template
            value_template: "{{ is_anyone_home and target_temp is none }}"
        sequence:
          - service: logbook.log
            data:
              name: "Smart Heating"
              message: "Brak ustalonej temperatury docelowej w harmonogramie. Bez zmian trybu HVAC."
              
      # 2. Gdy temperatura zewnętrzna jest powyżej limitu, WYŁĄCZ grzanie
      - conditions:
          - condition: numeric_state
            entity_id: "{{ trigger.input.external_temp_sensor }}"
            above: "{{ trigger.input.max_external_temp }}"
        sequence:
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ trigger.input.heating_entity }}"
            data:
              hvac_mode: 'off'
          - service: logbook.log
            data:
              name: "Smart Heating"
              message: "Zewnętrzna temperatura {{ ext_temp }}°C przekracza limit. TRV wyłączony (Off)."
              
      # 3. Standardowa logika włącz/wyłącz z histerezą
      - conditions:
          - condition: template
            value_template: "{{ target_temp is not none }}"
        sequence:
          - alias: "Porównaj z aktualną temperaturą (z histerezą)"
            choose:
              
              # Włączenie grzania: Temp wew. < (Docelowa - Histereza)
              - conditions:
                  - condition: numeric_state
                    entity_id: "{{ trigger.input.internal_temp_sensor }}"
                    below: "{{ target_temp | float(0) - hysteresis }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: "{{ trigger.input.heating_entity }}"
                    data:
                      hvac_mode: heat
                  - service: logbook.log
                    data:
                      name: "Smart Heating"
                      message: |
                        WŁĄCZAM TRV. Tryb: {% if is_anyone_home %}Obecność{% else %}Nieobecność{% endif %}.
                        Temp wew. {{ int_temp }}°C < min. {{ target_temp | float(0) - hysteresis }}°C.
              
              # Wyłączenie grzania: Temp wew. >= Docelowa
              - conditions:
                  - condition: numeric_state
                    entity_id: "{{ trigger.input.internal_temp_sensor }}"
                    above_or_equal: "{{ target_temp | float(0) }}"
                sequence:
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: "{{ trigger.input.heating_entity }}"
                    data:
                      hvac_mode: 'off'
                  - service: logbook.log
                    data:
                      name: "Smart Heating"
                      message: |
                        WYŁĄCZAM TRV. Tryb: {% if is_anyone_home %}Obecność{% else %}Nieobecność{% endif %}.
                        Temp wew. {{ int_temp }}°C >= docelowa {{ target_temp }}°C.
            
            default:
              - service: logbook.log
                data:
                  name: "Smart Heating"
                  message: "Temperatura jest w zakresie histerezy (brak zmian trybu HVAC)."
