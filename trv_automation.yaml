blueprint:
  name: Termostat 6 Stref Czasowych + Obecność (ON/OFF)
  description: Zaawansowane sterowanie TRV na podstawie 3 harmonogramów + Boost, obecności LUB oraz zabezpieczenia przed przegrzaniem (ON/OFF z histerezą).
  domain: automation
  input:
    trv_target:
      name: Głowica TRV (Climate)
      selector:
        entity: {domain: climate, multiple: false}
    room_sensor:
      name: Zewnętrzny Czujnik Temperatury (Wygładzony)
      description: Encja czujnika używana do odczytu temperatury w pomieszczeniu (zalecany filtr Moving Average).
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false
    
    # WEJŚCIA OBECNOŚCI (LOKALIZACJA TELEFONÓW)
    person_1_entity:
      name: Encja Obecności - Osoba 1
      description: Lokalizacja telefonu/osoby nr 1.
      selector:
        entity: {domain: [person, device_tracker]}
    person_2_entity:
      name: Encja Obecności - Osoba 2
      description: Lokalizacja telefonu/osoby nr 2.
      selector:
        entity: {domain: [person, device_tracker]}
    
    # WEJŚCIA TEMPERATURY
    temp_comfort:
      name: 1. Temperatura Komfortowa (DZIEŃ)
      default: 21.0
      selector:
        number: {min: 10, max: 30, unit_of_measurement: "°C", step: 0.5}
    temp_sleep:
      name: 2. Temperatura Nocna (SPANIE)
      default: 19.0
      selector:
        number: {min: 10, max: 30, unit_of_measurement: "°C", step: 0.5}
    temp_midday_away:
      name: 3. Temperatura Oszczędność (ŚRODEK DNIA)
      default: 18.0
      selector:
        number: {min: 10, max: 30, unit_of_measurement: "°C", step: 0.5}
    temp_boost:
      name: 4. Temperatura Boost (Wzmocnienie)
      description: Krótkotrwała podwyższona temperatura (np. rano w łazience).
      default: 23.0
      selector:
        number: {min: 15, max: 35, unit_of_measurement: "°C", step: 0.5}
    temp_away:
      name: 5. Temperatura Poza Domem (AWAY)
      default: 16.0
      selector:
        number: {min: 10, max: 30, unit_of_measurement: "°C", step: 0.5}
    temp_max_limit:
      name: 6. Temperatura Maksymalna (Zabezpieczenie)
      description: Temperatura, powyżej której TRV zostanie natychmiast wyłączony (np. 24.0°C).
      default: 24.0
      selector:
        number: {min: 15, max: 35, unit_of_measurement: "°C", step: 0.5}
    
    # WEJŚCIE Histereza
    histeresis:
      name: Histereza (°C)
      description: Margines tolerancji dla trybu ON/OFF, np. 0.2°C.
      default: 0.2
      selector:
        number:
          min: 0.1
          max: 1.0
          unit_of_measurement: °C
          step: 0.1

    # WEJŚCIA CZASOWE
    time_sleep:
      name: A. Godzina Rozpoczęcia Nocy
      description: np. 23:00
      selector: {time: }
    time_wake:
      name: B. Godzina Zakończenia Nocy
      description: np. 07:00
      selector: {time: }
    time_midday_start:
      name: C. Godzina Rozpoczęcia Oszczędności (Środek Dnia)
      description: np. 08:00
      selector: {time: }
    time_midday_end:
      name: D. Godzina Zakończenia Oszczędności (Środek Dnia)
      description: np. 16:00
      selector: {time: }
    time_boost:
      name: E. Godzina Rozpoczęcia Boost (Opcjonalnie)
      description: Godzina włączenia Boost (np. 06:30). Pozostaw puste, jeśli Boost nie jest potrzebny.
      selector: 
        time:
      nullable: true # TUTAJ POWINNO BYĆ!
    boost_duration:
      name: F. Czas Trwania Boost (minuty)
      description: Jak długo ma trwać Boost (np. 30 minut).
      default: 30
      selector:
        number: {min: 10, max: 120, unit_of_measurement: "min", step: 10}

mode: queued

variables:
  input_trv: !input trv_target
  input_room_sensor: !input room_sensor
  input_person_1: !input person_1_entity
  input_person_2: !input person_2_entity
  time_sleep_str: !input time_sleep
  time_wake_str: !input time_wake
  time_midday_start_str: !input time_midday_start
  time_midday_end_str: !input time_midday_end
  time_boost_str: !input time_boost
  boost_duration_min: !input boost_duration
  input_comfort_temp: !input temp_comfort
  input_sleep_temp: !input temp_sleep
  input_midday_away_temp: !input temp_midday_away
  input_boost_temp: !input temp_boost
  input_away_temp: !input temp_away
  input_max_temp: !input temp_max_limit
  histereza: !input histeresis


trigger:
  # 1. Zmiana statusu obecności
  - platform: state
    entity_id: !input person_1_entity
  - platform: state
    entity_id: !input person_2_entity
  # 2. Wyzwalanie w kluczowych godzinach (4 punkty harmonogramu + Boost)
  - platform: time
    at: !input time_sleep
  - platform: time
    at: !input time_wake
  - platform: time
    at: !input time_midday_start
  - platform: time
    at: !input time_midday_end
  - platform: time
    at: !input time_boost
  # 3. Zmiana temperatury z czujnika (dla szybkiej reakcji ON/OFF i przegrzania)
  - platform: state
    entity_id: !input room_sensor


action:
  # 1. Definiowanie zmiennych i Logika Harmonogramu
  - variables:
      now_time: "{{ now().time() }}"
      sleep_time: "{{ as_datetime(time_sleep_str).time() }}"
      wake_time: "{{ as_datetime(time_wake_str).time() }}"
      midday_start: "{{ as_datetime(time_midday_start_str).time() }}"
      midday_end: "{{ as_datetime(time_midday_end_str).time() }}"
      
      current_room_temp: "{{ states(input_room_sensor) | float(20.0) }}"
      trv_mode: "{{ state_attr(input_trv, 'hvac_action') }}"
      
      # Logika obecności: Prawda, gdy CO NAJMNIEJ JEDNA osoba jest w domu
      is_home: >
        {% set person_1_home = is_state(input_person_1, 'home') %}
        {% set person_2_home = is_state(input_person_2, 'home') %}
        {{ person_1_home or person_2_home }}
      
      # Zabezpieczenie przed przegrzaniem (PRIORYTET 0)
      is_overheating: "{{ current_room_temp >= input_max_temp }}"

      # Logika Boost (Aktywna tylko, gdy jesteś w domu)
      is_boost_time: >
        {% set time_boost_input = states(time_boost_str) %}
        {# Sprawdzenie, czy pole time_boost_str JEST UŻYWANE (nie jest puste) #}
        {% if time_boost_input is not none and time_boost_input not in ['unavailable', 'unknown'] %}
          {% set now_dt = now() %}
          {# Używamy time_boost_input bezpośrednio #}
          {% set boost_start = today_at(time_boost_input) %} 
          {% set boost_end = boost_start + timedelta(minutes=boost_duration_min | int) %}
          {# BOOST jest aktywny TYLKO gdy jesteś w domu i w przedziale czasowym #}
          {{ is_home and now_dt >= boost_start and now_dt < boost_end }}
        {% else %}
          {# Jeśli pole time_boost jest puste (brak wartości), Boost jest zawsze nieaktywny #}
          false
        {% endif %}
      
      # Logika Czasowa (Spanie):
      is_sleep_time: >
        {% if sleep_time > wake_time %}
          {{ now_time >= sleep_time or now_time < wake_time }}
        {% else %}
          {{ now_time >= sleep_time and now_time < wake_time }}
        {% endif %}

      # Logika Czasowa (Oszczędność w dzień):
      is_midday_time:
