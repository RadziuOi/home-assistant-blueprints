blueprint:
  name: Termostat Minimalny Stabilny (T_Dzień/Noc/Away)
  description: Kontrola TRV oparta na Twojej stabilnej logice: Dzień/Noc/Away i ścisłej histerezie ON/OFF (0.1°C).
  domain: automation
  input:
    trv_target:
      name: Głowica TRV (Climate)
      selector:
        entity: {domain: climate, multiple: false}
    room_sensor:
      name: Zewnętrzny Czujnik Temperatury
      description: Encja czujnika używana do odczytu temperatury w pomieszczeniu.
      selector:
        entity:
          domain: sensor
          device_class: temperature
          multiple: false
    
    person_1_entity:
      name: Encja Obecności - Osoba 1
      selector:
        entity: {domain: [person, device_tracker]}
    person_2_entity:
      name: Encja Obecności - Osoba 2
      selector:
        entity: {domain: [person, device_tracker]}
    
    temp_comfort:
      name: Temperatura Komfortowa (DZIEŃ)
      default: 21.0
      selector:
        number: {min: 15, max: 30, unit_of_measurement: "°C", step: 0.5}
    temp_sleep_away:
      name: Temperatura Nocna / Poza Domem
      default: 19.0
      selector:
        number: {min: 10, max: 25, unit_of_measurement: "°C", step: 0.5}
    
    histeresis:
      name: Histereza (°C)
      description: Margines tolerancji (np. 0.1°C).
      default: 0.1
      selector:
        number:
          min: 0.1
          max: 1.0
          unit_of_measurement: °C
          step: 0.1

    time_sleep:
      name: Godzina Rozpoczęcia Nocy
      description: np. 21:00
      selector: {time: }
    time_wake:
      name: Godzina Zakończenia Nocy
      description: np. 07:00
      selector: {time: }

mode: queued

variables:
  input_trv: !input trv_target
  input_room_sensor: !input room_sensor
  input_person_1: !input person_1_entity
  input_person_2: !input person_2_entity
  time_sleep_str: !input time_sleep
  time_wake_str: !input time_wake
  histereza: !input histeresis

trigger:
  # 1. Zmiana statusu obecności
  - platform: state
    entity_id: !input person_1_entity
  - platform: state
    entity_id: !input person_2_entity
  # 2. Wyzwalanie w kluczowych godzinach
  - platform: time
    at: !input time_sleep
  - platform: time
    at: !input time_wake
  # 3. Zmiana temperatury z czujnika
  - platform: state
    entity_id: !input room_sensor


action:
  # 1. Definiowanie zmiennych i Logika Harmonogramu
  - variables:
      now_time: "{{ now().time() }}"
      sleep_time: "{{ as_datetime(time_sleep_str).time() }}"
      wake_time: "{{ as_datetime(time_wake_str).time() }}"
      
      current_room_temp: "{{ states(input_room_sensor) | float(20.0) }}" # Wymuszony FLOAT
      trv_mode: "{{ state_attr(input_trv, 'hvac_action') }}"
      
      # Logika obecności: Prawda, gdy CO NAJMNIEJ JEDNA osoba jest w domu
      is_home: >
        {% set person_1_home = is_state(input_person_1, 'home') %}
        {% set person_2_home = is_state(input_person_2, 'home') %}
        {{ person_1_home or person_2_home }}
      
      # Logika Czasowa (Spanie): Poprawna Logika Przełomu Północy
      is_sleep_time: >
        {% if sleep_time > wake_time %}
          {{ now_time >= sleep_time or now_time < wake_time }}
        {% else %}
          {{ now_time >= sleep_time and now_time < wake_time }}
        {% endif %}
        
      # 2. Obliczanie docelowej temperatury (Referencyjnej)
      target_temp: >
        {% if not is_home %}
          {# PRIORYTET 1: JESTEŚMY POZA DOMEM #}
          {{ input_sleep_away | float(19.0) }} 
        {% elif is_sleep_time %}
          {# PRIORYTET 2: CZAS SPANIA (NOC) #}
          {{ input_sleep_away | float(19.0) }} 
        {% else %}
          {# PRIORYTET 3: CZAS KOMFORTU #}
          {{ input_comfort_temp | float(21.0) }}
        {% endif %}

      # 3. Logika Decyzyjna ON/OFF z Histerezą
      target_hvac_mode: >
        {% set histereza_float = histereza | float(0.1) %} # Wymuszony FLOAT
        {% set target_temp_float = target_temp | float(21.0) %} 
        
        {% if current_room_temp >= target_temp_float + histereza_float %} 
          {# WYŁĄCZENIE (powyżej zadanej + margines) #}
          off
        
        {% elif current_room_temp <= target_temp_float - histereza_float %} 
          {# WŁĄCZENIE (poniżej zadanej - margines) #}
          heat

        {% elif trv_mode == 'heating' or trv_mode == 'heat' %}
          {# KONTYNUACJA GRZANIA (w marginesie) #}
          heat
        
        {% else %}
          {# KONTYNUACJA WYŁĄCZENIA (w marginesie) #}
          off
        {% endif %}
      
  # 4. Akcje (Ustawienie trybu i temperatury referencyjnej)
  - service: climate.set_hvac_mode
    target:
      entity_id: "{{ input_trv }}"
    data:
      hvac_mode: "{{ target_hvac_mode }}"

  - service: climate.set_temperature
    target:
      entity_id: "{{ input_trv }}"
    data:
      temperature: "{{ target_temp }}"
