blueprint:
  name: Sterowanie ogrzewaniem (Smart Heating - Climate/TRV)
  description: |
    Automatyczne sterowanie Termostatycznym Zaworem Grzejnikowym (TRV) / Climate na podstawie:
      • Temperatury zewnętrznego czujnika,
      • Harmonogramu czasowego (dzień / noc),
      • Obecności osób w domu.
    
    Wspiera:
      * Różne ustawienia temperatury w zależności od godziny
      * Wyłączanie grzania, gdy temperatura zewnętrzna jest już wysoka
      * Opcjonalna histereza (krok) przy zmianie temperatury.
    **UWAGA: Ten Blueprint steruje trybem HVAC (Heat/Off), a nie temperaturą docelową.**
  domain: automation
  input:
    # Czujnik temperatury zewnętrznej
    external_temp_sensor:
      name: Temperatura zewnętrzna
      description: Sensor typu temperature
      selector:
        entity:
          domain: sensor

    # Czujnik temperatury wewnętrznej
    internal_temp_sensor:
      name: Temperatura wewnętrzna
      description: Sensor temperatury pomieszczenia, który ma być kontrolowany
      selector:
        entity:
          domain: sensor

    # TRV / Termostat do sterowania (KLUCZOWA ZMIANA: domena climate)
    heating_entity:
      name: TRV / Termostat (Encja Climate)
      description: Encja Climate, której tryb HVAC zostanie ustawiony (np. climate.trv_salon)
      selector:
        entity:
          domain: climate # Jawne ograniczenie do termostatów/TRV

    # Czy w domu jest ktoś?
    presence_sensor:
      name: Sensor obecności
      description: Binary sensor, który zwraca „on” gdy ktoś jest w domu
      selector:
        entity:
          domain: binary_sensor

    # Częstotliwość sprawdzania (sekundy)
    check_interval:
      name: Interwał sprawdzania (s)
      default: 60
      selector:
        number:
          min: 10
          max: 3600
          unit_of_measurement: s

    # Temperatura docelowa w zależności od czasu i obecności
    temp_schedule:
      name: Harmonogram temperatury
      description: |
        Lista wpisów z czasem, dniami oraz temperaturą.
        Wartości z "temp" będą służyły jako docelowe, wokół których
        będzie liczona histereza.
      selector:
        object:

    # Temperatura maksymalna zewnętrzna, po której grzanie wyłączone (bezpiecznik)
    max_external_temp:
      name: Maksymalna temperatura zewnętrzna
      default: 25
      selector:
        number:
          unit_of_measurement: °C
    
    # Histereza temperatury (krok)
    temperature_hysteresis:
      name: Histereza temperatury (krok)
      description: |
        Margines (np. 0.5 °C) zapobiegający częstemu przełączaniu trybu HVAC
        wokół temperatury docelowej.
      default: 0.0
      selector:
        number:
          min: 0.0
          max: 5.0
          step: 0.1
          unit_of_measurement: °C

mode: restart

trigger:
  - platform: time_pattern
    minutes: "/{{ trigger.input.check_interval }}"
  
action:
  - alias: "Pobierz aktualne wartości"
    variables:
      now_time: "{{ now().time() }}"
      weekday: "{{ now().strftime('%a').lower() }}"    # mon, tue, ...
      ext_temp: "{{ states(trigger.input.external_temp_sensor) | float(0) }}"
      int_temp: "{{ states(trigger.input.internal_temp_sensor) | float(0) }}"
      presence: "{{ is_state(trigger.input.presence_sensor, 'on') }}"
      hysteresis: "{{ trigger.input.temperature_hysteresis | float(0) }}"

  - alias: "Wybierz odpowiednią temperaturę z harmonogramu"
    variables:
      # znajdź wpis który pasuje do aktualnego czasu i dnia
      target_temp_entry: >-
        {%- set entries = trigger.input.temp_schedule %}
        {%- for entry in entries if weekday in (entry.days | default([])) and
              now_time >= strptime(entry.start, '%H:%M').time() and
              now_time < strptime(entry.end,   '%H:%M').time()
        -%}
          {{ entry }}
        {%- endfor %}
        {%- if entries|length == 0 %}null{%- endif %}
      target_temp: "{{ (target_temp_entry | default({}))['temp'] | default(null) }}"

  - alias: "Decyzja o włączeniu/wyłączeniu grzania (TRV/Climate)"
    choose:
      # 1. Gdy temperatura zewnętrzna jest powyżej limitu, WYŁĄCZ grzanie
      - conditions:
          - condition: numeric_state
            entity_id: "{{ trigger.input.external_temp_sensor }}"
            above: "{{ trigger.input.max_external_temp }}"
        sequence:
          # Użycie usługi climate.set_hvac_mode: 'off'
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ trigger.input.heating_entity }}"
            data:
              hvac_mode: 'off'
          - service: logbook.log
            data:
              name: "Smart Heating"
              message: |
                Zewnętrzna temperatura {{ ext_temp }}°C przekracza limit. TRV wyłączony (Off).

      # 2. Gdy nie ma osoby w domu, ZAWSZE WŁĄCZ (możesz tu ustawić minimalną temp.)
      - conditions:
          - condition: template
            value_template: "{{ not presence }}"
        sequence:
          # Użycie usługi climate.set_hvac_mode: 'heat'
          - service: climate.set_hvac_mode
            target:
              entity_id: "{{ trigger.input.heating_entity }}"
            data:
              hvac_mode: heat 
          - service: logbook.log
            data:
              name: "Smart Heating"
              message: |
                Nie ma nikogo w domu – TRV włączony (Heat/Auto) (tryb nieobecności).

      # 3. Standardowa reguła: włącz/wyłącz na podstawie temperatury wewnętrznej i harmonogramu
      - conditions:
          - condition: template
            value_template: "{{ presence and target_temp is not none }}"
        sequence:
          - alias: "Porównaj z aktualną temperaturą (z histerezą)"
            choose:
              # Włączenie grzania: Temp wew. < (Docelowa - Histereza)
              - conditions:
                  - condition: numeric_state
                    entity_id: "{{ trigger.input.internal_temp_sensor }}"
                    below: "{{ target_temp | float(0) - hysteresis }}"
                sequence:
                  # Użycie usługi climate.set_hvac_mode: 'heat'
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: "{{ trigger.input.heating_entity }}"
                    data:
                      hvac_mode: heat
                  - service: logbook.log
                    data:
                      name: "Smart Heating"
                      message: |
                        WŁĄCZAM TRV. Temp wew. {{ int_temp }}°C < min. {{ target_temp | float(0) - hysteresis }}°C.
                        (Docelowa: {{ target_temp }}°C, Histereza: {{ hysteresis }}°C)
              
              # Wyłączenie grzania: Temp wew. >= Docelowa
              - conditions:
                  - condition: numeric_state
                    entity_id: "{{ trigger.input.internal_temp_sensor }}"
                    above_or_equal: "{{ target_temp | float(0) }}"
                sequence:
                  # Użycie usługi climate.set_hvac_mode: 'off'
                  - service: climate.set_hvac_mode
                    target:
                      entity_id: "{{ trigger.input.heating_entity }}"
                    data:
                      hvac_mode: 'off'
                  - service: logbook.log
                    data:
                      name: "Smart Heating"
                      message: |
                        WYŁĄCZAM TRV. Temp wew. {{ int_temp }}°C >= docelowa {{ target_temp }}°C.
            default:
              - service: logbook.log
                data:
                  name: "Smart Heating"
                  message: "Temperatura jest w zakresie histerezy. Bez zmian trybu HVAC."

    default:
      - service: logbook.log
        data:
          name: "Smart Heating"
          message: "Brak ustalonej temperatury docelowej. TRV pozostaje bez zmian."
