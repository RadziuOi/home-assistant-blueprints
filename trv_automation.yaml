blueprint:
  name: Sterowanie ogrzewaniem (Smart Heating)
  description: |
    Automatyczne sterowanie grzałką/klimatyzacją na podstawie:
      • Temperatury zewnętrznego czujnika,
      • Harmonogramu czasowego (dzień / noc),
      • Obecności osób w domu.
    
    Wspiera:
      * Różne ustawienia temperatury w zależności od godziny
      * Wyłączanie grzałki, gdy temperatura zewnętrzna jest już wysoka
      * **Opcjonalna histereza (krok) przy zmianie temperatury,
        aby uniknąć częstych cykli.**
  domain: automation
  input:
    # Czujnik temperatury zewnętrznej
    external_temp_sensor:
      name: Temperatura zewnętrzna
      description: Sensor typu temperature
      selector:
        entity:
          domain: sensor

    # Czujnik temperatury wewnętrznej (opcjonalny – można użyć do porównania)
    internal_temp_sensor:
      name: Temperatura wewnętrzna (opcjonalna)
      description: Sensor temperatury pomieszczenia, który ma być kontrolowany
      selector:
        entity:
          domain: sensor
      default: ""

    # Grzałka / klimatyzacja do sterowania
    heating_entity:
      name: Grzałka/klimatyzacja
      description: Entity (switch / climate) które zostanie włączone/wyłączone
      selector:
        entity:

    # Czy w domu jest ktoś?
    presence_sensor:
      name: Sensor obecności
      description: Binary sensor, który zwraca „on” gdy ktoś jest w domu
      selector:
        entity:
          domain: binary_sensor

    # Częstotliwość sprawdzania (sekundy)
    check_interval:
      name: Interwał sprawdzania (s)
      default: 60
      selector:
        number:
          min: 10
          max: 3600
          unit_of_measurement: s

    # Temperatura docelowa w zależności od czasu i obecności
    temp_schedule:
      name: Harmonogram temperatury
      description: |
        Lista wpisów z czasem, dniami oraz temperaturą.
        Format JSON (np. podaj w UI jako listę dictów):
          [
            {"start":"06:00","end":"09:00","temp":21,"days":["mon","tue","wed","thu","fri"]},
            ...
          ]
      selector:
        object:

    # Temperatura maksymalna zewnętrzna, po której grzałka wyłączona (bezpiecznik)
    max_external_temp:
      name: Maksymalna temperatura zewnętrzna
      default: 25
      selector:
        number:
          unit_of_measurement: °C
    
    # NOWY PARAMETR: Histereza temperatury (krok)
    temperature_hysteresis:
      name: Histereza temperatury (krok)
      description: |
        Margines (np. 0.5 °C) zapobiegający częstemu włączaniu/wyłączaniu
        grzałki wokół temperatury docelowej.
      default: 0.0
      selector:
        number:
          min: 0.0
          max: 5.0
          step: 0.1
          unit_of_measurement: °C

mode: restart

trigger:
  - platform: time_pattern
    minutes: "/{{ trigger.input.check_interval }}"
  
action:
  - alias: "Pobierz aktualne wartości"
    variables:
      now_time: "{{ now().time() }}"
      weekday: "{{ now().strftime('%a').lower() }}"    # mon, tue, ...
      # POPRAWKA: Używamy states() zamiast state_attr(..., 'temperature')
      ext_temp: "{{ states(trigger.input.external_temp_sensor) | float(0) }}"
      int_temp: >-
        {% if trigger.input.internal_temp_sensor %}
          {{ states(trigger.input.internal_temp_sensor) | float(0) }}
        {% else %}
          null
        {% endif %}
      presence: "{{ is_state(trigger.input.presence_sensor, 'on') }}"
      hysteresis: "{{ trigger.input.temperature_hysteresis | float(0) }}"

  - alias: "Wybierz odpowiednią temperaturę z harmonogramu"
    variables:
      # znajdź wpis który pasuje do aktualnego czasu i dnia
      target_temp_entry: >-
        {%- set entries = trigger.input.temp_schedule %}
        {%- for entry in entries if weekday in (entry.days | default([])) and
              now_time >= strptime(entry.start, '%H:%M').time() and
              now_time < strptime(entry.end,   '%H:%M').time()
        -%}
          {{ entry }}
        {%- endfor %}
        {%- if entries|length == 0 %}null{%- endif %}
      target_temp: "{{ (target_temp_entry | default({}))['temp'] | default(null) }}"

  - alias: "Decyzja o włączeniu/wyłączeniu grzałki"
    choose:
      # Gdy temperatura zewnętrzna jest powyżej limitu, wyłącz wszystko
      - conditions:
          - condition: numeric_state
            entity_id: "{{ trigger.input.external_temp_sensor }}"
            above: "{{ trigger.input.max_external_temp }}"
        sequence:
          - service: homeassistant.turn_off
            target:
              entity_id: "{{ trigger.input.heating_entity }}"
          - service: logbook.log
            data:
              name: "Smart Heating"
              message: |
                Zewnętrzna temperatura {{ ext_temp }}°C przekracza limit
                ({{ trigger.input.max_external_temp }}°C). Grzałka wyłączona.

      # Gdy nie ma osoby w domu, ZAWSZE włącz (można to ulepszyć w przyszłości)
      - conditions:
          - condition: template
            value_template: "{{ not presence }}"
        sequence:
          - service: homeassistant.turn_on
            target:
              entity_id: "{{ trigger.input.heating_entity }}"
          - service: logbook.log
            data:
              name: "Smart Heating"
              message: |
                Nie ma nikogo w domu – grzałka pozostaje włączona (tryb nieobecności).

      # Standardowa reguła: włącz/wyłącz na podstawie temperatury wewnętrznej i harmonogramu
      - conditions:
          - condition: template
            value_template: "{{ presence and target_temp is not none }}"
        sequence:
          - alias: "Porównaj z aktualną temperaturą (z histerezą)"
            choose:
              # Warunek włączenia: Temp wew. < (Docelowa - Histereza)
              - conditions:
                  - condition: numeric_state
                    entity_id: "{{ trigger.input.internal_temp_sensor }}"
                    below: "{{ target_temp | float(0) - hysteresis }}"
                sequence:
                  - service: homeassistant.turn_on
                    target:
                      entity_id: "{{ trigger.input.heating_entity }}"
                  - service: logbook.log
                    data:
                      name: "Smart Heating"
                      message: |
                        Włączam grzałkę. Temp wew. {{ int_temp }}°C < min. {{ target_temp | float(0) - hysteresis }}°C.
                        (Docelowa: {{ target_temp }}°C, Histereza: {{ hysteresis }}°C)
              
              # Warunek wyłączenia: Temp wew. >= Docelowa
              - conditions:
                  - condition: numeric_state
                    entity_id: "{{ trigger.input.internal_temp_sensor }}"
                    above_or_equal: "{{ target_temp | float(0) }}"
                sequence:
                  - service: homeassistant.turn_off
                    target:
                      entity_id: "{{ trigger.input.heating_entity }}"
                  - service: logbook.log
                    data:
                      name: "Smart Heating"
                      message: |
                        Wyłączam grzałkę. Temp wew. {{ int_temp }}°C >= docelowa {{ target_temp }}°C.
            default:
              - service: logbook.log
                data:
                  name: "Smart Heating"
                  message: |
                    Temperatura jest w zakresie histerezy ({{ target_temp | float(0) - hysteresis }}°C - {{ target_temp }}°C). Bez zmian.

    default:
      - service: logbook.log
        data:
          name: "Smart Heating"
          message: "Brak ustalonej temperatury docelowej dla aktualnego czasu/dnia."
